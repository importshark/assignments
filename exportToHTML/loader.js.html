<html>
<head>
<title>loader.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #a9b7c6;}
.s1 { color: #6a8759;}
.s2 { color: #808080;}
.s3 { color: #cc7832;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
loader.js</font>
</center></td></tr></table>
<pre><span class="s0">const fs = require(</span><span class="s1">'fs'</span><span class="s0">);</span>
<span class="s0">const {</span>
    <span class="s0">spawn,</span>
    <span class="s0">spawnSync,</span>
    <span class="s0">fork</span>
<span class="s0">} = require(</span><span class="s1">'child_process'</span><span class="s0">);</span>
<span class="s2">//const {spawnArgs, nodePath} = require('./loaderData.json')</span>
<span class="s0">const http = require(</span><span class="s1">'http'</span><span class="s0">);</span>
<span class="s0">const express = require(</span><span class="s1">'express'</span><span class="s0">);</span>
<span class="s3">var </span><span class="s0">cookieParser = require(</span><span class="s1">'cookie-parser'</span><span class="s0">)</span>
<span class="s0">const app = express();</span>
<span class="s0">app.use(cookieParser())</span>
<span class="s0">const server = http.createServer(app);</span>
<span class="s0">const {</span>
    <span class="s0">Server</span>
<span class="s0">} = require(</span><span class="s1">&quot;socket.io&quot;</span><span class="s0">);</span>
<span class="s0">const io = </span><span class="s3">new </span><span class="s0">Server(server);</span>
<span class="s3">var </span><span class="s0">request = require(</span><span class="s1">'then-request'</span><span class="s0">);;</span>
<span class="s0">const extract = require(</span><span class="s1">'extract-zip'</span><span class="s0">)</span>
<span class="s0">const fetch = require(</span><span class="s1">'node-fetch'</span><span class="s0">);</span>
<span class="s0">const sm = require(</span><span class="s1">'./sm/socketManager'</span><span class="s0">)</span>
<span class="s0">let cacher = require(</span><span class="s1">'./cache/cache.js'</span><span class="s0">);</span>
<span class="s3">var </span><span class="s0">events = require(</span><span class="s1">&quot;events&quot;</span><span class="s0">);</span>
<span class="s0">app.set(</span><span class="s1">'views'</span><span class="s0">, </span><span class="s1">'./assets/views'</span><span class="s0">);</span>
<span class="s0">app.set(</span><span class="s1">'view engine'</span><span class="s0">, </span><span class="s1">'pug'</span><span class="s0">)</span>


<span class="s0">let currentlyRunning = </span><span class="s3">false</span><span class="s0">;</span>

<span class="s0">async </span><span class="s3">function </span><span class="s0">download(url, dest) {</span>
    <span class="s0">const response = await fetch(url);</span>
    <span class="s0">const file = fs.createWriteStream(dest);</span>
    <span class="s3">return new </span><span class="s0">Promise((resolve, reject) =&gt; {</span>
        <span class="s0">response.body.pipe(file);</span>
        <span class="s0">file.on(</span><span class="s1">'finish'</span><span class="s0">, </span><span class="s3">function</span><span class="s0">() {</span>
            <span class="s0">file.close();</span>
            <span class="s0">resolve();</span>
        <span class="s0">});</span>
        <span class="s0">file.on(</span><span class="s1">'error'</span><span class="s0">, </span><span class="s3">function</span><span class="s0">(err) {</span>
            <span class="s0">fs.unlink(dest, () =&gt; {});</span>
            <span class="s0">reject(err);</span>
        <span class="s0">});</span>
    <span class="s0">});</span>
<span class="s0">}</span>


<span class="s3">function </span><span class="s0">run(data){</span>

    <span class="s0">const {id, args} = data;</span>

                  <span class="s0">const child = spawn(</span><span class="s1">&quot;node&quot;</span><span class="s0">, args, { cwd: </span><span class="s1">&quot;./exercise/&quot;</span><span class="s0">})</span>

                          <span class="s0">child.stdout.on(</span><span class="s1">'data'</span><span class="s0">, </span><span class="s3">function</span><span class="s0">(data){</span>
                              <span class="s0">sm.send(id, </span><span class="s1">'childStdout'</span><span class="s0">, data);</span>
                          <span class="s0">})</span>

                          <span class="s0">child.on(</span><span class="s1">&quot;error&quot;</span><span class="s0">, </span><span class="s3">function</span><span class="s0">(err){</span>

                            <span class="s0">sm.send(id, </span><span class="s1">'childError'</span><span class="s0">, err)</span>

                          <span class="s0">})</span>

                          <span class="s0">child.stderr.on(</span><span class="s1">'data'</span><span class="s0">, </span><span class="s3">function</span><span class="s0">(data){</span>
                                  <span class="s0">sm.send(id, </span><span class="s1">'childStderr'</span><span class="s0">, data);</span>
                              <span class="s0">})</span>
                              <span class="s0">child.on(</span><span class="s1">'close'</span><span class="s0">, </span><span class="s3">function</span><span class="s0">(code){</span>
                                  <span class="s0">currentlyRunning = </span><span class="s3">false</span><span class="s0">;</span>
                                  <span class="s0">sm.finish(id);</span>
                              <span class="s0">})</span>
<span class="s0">}</span>



<span class="s0">async </span><span class="s3">function </span><span class="s0">initiateRun(){</span>



    <span class="s2">//get the first user in the queue</span>
    <span class="s0">console.log(</span><span class="s1">&quot;run&quot;</span><span class="s0">)</span>
        <span class="s0">let data = sm.getFirst();</span>

        <span class="s0">let {modules} = require(</span><span class="s1">'./cache/cache.json'</span><span class="s0">);</span>

        <span class="s0">let module = modules[data.args[</span><span class="s4">0</span><span class="s0">] - </span><span class="s4">1</span><span class="s0">]</span>

        <span class="s0">console.log(module)</span>





        <span class="s0">sm.send(data.id, </span><span class="s1">&quot;runInit&quot;</span><span class="s0">)</span>



        <span class="s0">data.args.shift(); </span><span class="s2">//remove package id</span>
        <span class="s0">data.args.unshift(</span><span class="s1">&quot;main.js&quot;</span><span class="s0">)</span>

        <span class="s0">let moduleFile = </span><span class="s3">false</span><span class="s0">;</span>

        
        
        
    <span class="s3">try</span><span class="s0">{</span>
        <span class="s0">moduleFile = JSON.parse(fs.readFileSync(</span><span class="s1">&quot;./exercise/module.json&quot;</span><span class="s0">))</span>
        <span class="s0">console.log(!moduleFile.id)</span>
        <span class="s3">if</span><span class="s0">(!moduleFile.id) </span><span class="s3">throw new </span><span class="s0">Error(</span><span class="s1">&quot;Incorrect package&quot;</span><span class="s0">)</span>
        <span class="s3">if</span><span class="s0">(moduleFile.id != module.id) </span><span class="s3">throw new </span><span class="s0">Error(</span><span class="s1">&quot;Incorrect package&quot;</span><span class="s0">)</span>
    <span class="s0">}    </span>
    <span class="s3">catch</span><span class="s0">(err){</span>



            <span class="s0">err ? console.error(err) : console.log(</span><span class="s1">&quot;No error&quot;</span><span class="s0">)</span>

        
            <span class="s0">const emitter = install(module)</span>
            <span class="s0">emitter.on(</span><span class="s1">&quot;done&quot;</span><span class="s0">, </span><span class="s3">function</span><span class="s0">(){</span>

                <span class="s0">console.log(</span><span class="s1">&quot;Can anybody hear me&quot;</span><span class="s0">)</span>
                
            <span class="s3">return </span><span class="s0">run(data)</span>
    
               
    


            <span class="s0">})</span>
        <span class="s0">}</span>
        <span class="s0">run(data)</span>
        
           
            <span class="s0">};</span>

        







<span class="s0">app.get(</span><span class="s1">'/assignments/'</span><span class="s0">, async (req, res) =&gt; {</span>



    <span class="s0">const id = req.query.id</span>
    <span class="s0">const force = req.query.forceReCache</span>



    <span class="s0">let cached = cacher.isCached()</span>

    <span class="s3">if </span><span class="s0">(force || !cacher.isCached()) {</span>

        <span class="s0">console.log(</span><span class="s1">&quot;Caching data as forced&quot;</span><span class="s0">)</span>
        <span class="s0">await cacher.download()</span>


    <span class="s0">}</span>

    <span class="s0">const cache = cacher.getCache()</span>

    <span class="s2">//array id is id - 1</span>

    <span class="s2">//assign data</span>
    <span class="s0">const data = cache.modules[id - </span><span class="s4">1</span><span class="s0">]</span>

    <span class="s0">console.log(</span><span class="s1">&quot;User connected.&quot;</span><span class="s0">)</span>




    <span class="s3">return </span><span class="s0">res.render(</span><span class="s1">'assignment'</span><span class="s0">, {</span>
        <span class="s0">data: {</span>
            <span class="s0">id: id,</span>
            <span class="s0">moduleData: data</span>
        <span class="s0">}</span>
    <span class="s0">})</span>




<span class="s0">})</span>


<span class="s3">function </span><span class="s0">install(module) {</span>

    <span class="s0">const emitter = </span><span class="s3">new </span><span class="s0">events.EventEmitter();</span>


    <span class="s0">console.log(</span><span class="s1">&quot;Here&quot;</span><span class="s0">)</span>

    <span class="s0">console.log(module)</span>

    <span class="s0">request(</span><span class="s1">'GET'</span><span class="s0">, module.url).done(</span><span class="s3">function </span><span class="s0">(res) {</span>
        <span class="s0">let body = res.getBody()</span>

          <span class="s3">try</span><span class="s0">{</span>
           <span class="s0">fs.writeFileSync(</span><span class="s1">&quot;./exercise.zip&quot;</span><span class="s0">, body)</span>
          <span class="s0">}</span><span class="s3">catch</span><span class="s0">(e){</span>
              <span class="s0">console.log(e)</span>

              <span class="s3">throw new </span><span class="s0">Error(e)</span>

          <span class="s0">}</span>

          <span class="s0">extract(</span><span class="s1">&quot;./exercise.zip&quot;</span><span class="s0">, {</span>
            <span class="s0">dir: `${__dirname}/exercise`</span>
        <span class="s0">})</span>
          
        <span class="s0">emitter.emit(</span><span class="s1">&quot;done&quot;</span><span class="s0">)</span>
  <span class="s0">})</span>

  <span class="s3">return </span><span class="s0">emitter;</span>


    




<span class="s0">}</span>

<span class="s0">io.on(</span><span class="s1">'connection'</span><span class="s0">, async (socket) =&gt; {</span>


    <span class="s0">console.log(</span><span class="s1">'a user connected at ' </span><span class="s0">+ socket.id);</span>
    <span class="s0">console.log(</span><span class="s1">&quot;Passing to socketManager...&quot;</span><span class="s0">)</span>

    <span class="s0">socket.emit(</span><span class="s1">&quot;transfer_start&quot;</span><span class="s0">)</span>
    <span class="s0">await sm.connect(socket)</span>

<span class="s0">});</span>

<span class="s0">app.get(</span><span class="s1">'/'</span><span class="s0">, async (req, res) =&gt; {</span>


    <span class="s0">const force = req.query.forceReCache</span>

    <span class="s0">console.log(</span><span class="s1">'force cache load: ' </span><span class="s0">+ force);</span>

    <span class="s0">console.log(</span><span class="s1">'is cache loaded: ' </span><span class="s0">+ cacher.isCached())</span>

    <span class="s3">if </span><span class="s0">(force || !cacher.isCached()) {</span>
        <span class="s0">console.log(</span><span class="s1">&quot;Recaching...&quot;</span><span class="s0">)</span>
        <span class="s0">await cacher.download();</span>
    <span class="s0">}</span>




    <span class="s0">let data = cacher.getCache();</span>

    <span class="s2">//res.sendFile(&quot;html/index.html&quot;, {root: &quot;.&quot;})</span>
    <span class="s0">res.status(</span><span class="s4">200</span><span class="s0">).render(</span><span class="s1">&quot;index&quot;</span><span class="s0">, {</span>
        <span class="s0">stuffs: data.modules</span>
    <span class="s0">})</span>
<span class="s0">})</span>

<span class="s0">app.get(</span><span class="s1">'/assets/js/index.js'</span><span class="s0">, (req, res) =&gt; {</span>
    <span class="s0">res.status(</span><span class="s4">200</span><span class="s0">).sendFile(</span><span class="s1">&quot;/assets/js/index.js&quot;</span><span class="s0">, {</span>
        <span class="s0">root: </span><span class="s1">&quot;.&quot;</span>
    <span class="s0">})</span>
    <span class="s2">//res.render(&quot;index&quot;, {data: 1})</span>
<span class="s0">})</span>

<span class="s0">app.get(</span><span class="s1">'/assets/js/assignment.js'</span><span class="s0">, (req, res) =&gt; {</span>
    <span class="s0">res.status(</span><span class="s4">200</span><span class="s0">).sendFile(</span><span class="s1">&quot;/assets/js/assignment.js&quot;</span><span class="s0">, {</span>
        <span class="s0">root: </span><span class="s1">&quot;.&quot;</span>
    <span class="s0">})</span>
    <span class="s2">//res.render(&quot;index&quot;, {data: 1})</span>
<span class="s0">})</span>

<span class="s0">app.get(</span><span class="s1">'/assets/js/functions.js'</span><span class="s0">, (req, res) =&gt; {</span>
    <span class="s0">res.status(</span><span class="s4">200</span><span class="s0">).sendFile(</span><span class="s1">&quot;/assets/js/functions.js&quot;</span><span class="s0">, {</span>
        <span class="s0">root: </span><span class="s1">&quot;.&quot;</span>
    <span class="s0">})</span>
    <span class="s2">//res.render(&quot;index&quot;, {data: 1})</span>
<span class="s0">})</span>

<span class="s0">app.get(</span><span class="s1">'/assets/css/assignment.css'</span><span class="s0">, (req, res) =&gt; {</span>
    <span class="s0">res.status(</span><span class="s4">200</span><span class="s0">).sendFile(</span><span class="s1">&quot;/assets/css/assignment.css&quot;</span><span class="s0">, {</span>
        <span class="s0">root: </span><span class="s1">&quot;.&quot;</span>
    <span class="s0">})</span>
    <span class="s2">//res.render(&quot;index&quot;, {data: 1})</span>
<span class="s0">})</span>



<span class="s0">app.get(</span><span class="s1">'/assets/images/favicons/favicon.ico'</span><span class="s0">, (req, res) =&gt; {</span>
    <span class="s0">res.status(</span><span class="s4">200</span><span class="s0">).sendFile(</span><span class="s1">&quot;/assets/images/favicons/favicon.ico&quot;</span><span class="s0">, {</span>
        <span class="s0">root: </span><span class="s1">&quot;.&quot;</span>
    <span class="s0">})</span>
<span class="s0">})</span>

<span class="s0">app.get(</span><span class="s1">'/assets/images/home.png'</span><span class="s0">, (req, res) =&gt; {</span>
    <span class="s0">res.status(</span><span class="s4">200</span><span class="s0">).sendFile(</span><span class="s1">&quot;/assets/images/home.png&quot;</span><span class="s0">, {</span>
        <span class="s0">root: </span><span class="s1">&quot;.&quot;</span>
    <span class="s0">})</span>
<span class="s0">})</span>

<span class="s0">app.get(</span><span class="s1">'/assets/images/favicon.ico'</span><span class="s0">, (req, res) =&gt; {</span>
    <span class="s0">res.status(</span><span class="s4">200</span><span class="s0">).sendFile(</span><span class="s1">&quot;/assets/images/favicon.ico&quot;</span><span class="s0">, {</span>
        <span class="s0">root: </span><span class="s1">&quot;.&quot;</span>
    <span class="s0">})</span>
<span class="s0">})</span>

<span class="s0">app.get(</span><span class="s1">'/assets/images/backgroundUpdate.png'</span><span class="s0">, (req, res) =&gt; {</span>
    <span class="s0">res.status(</span><span class="s4">200</span><span class="s0">).sendFile(</span><span class="s1">&quot;/assets/images/backgroundUpdate.png&quot;</span><span class="s0">, {</span>
        <span class="s0">root: </span><span class="s1">&quot;.&quot;</span>
    <span class="s0">})</span>
<span class="s0">})</span>

<span class="s0">server.listen(</span><span class="s4">3000</span><span class="s0">, </span><span class="s3">function</span><span class="s0">() {</span>
    <span class="s0">console.log(</span><span class="s1">&quot;Loader web app is listening on port 3000.&quot;</span><span class="s0">)</span>

<span class="s0">})</span>

<span class="s0">setInterval(() =&gt; {</span>

   <span class="s0">let data = sm.getFirst()</span>


    <span class="s3">if</span><span class="s0">(!data) </span><span class="s3">return</span>
    <span class="s3">if</span><span class="s0">(data.id === currentlyRunning) </span><span class="s3">return</span>

    <span class="s0">initiateRun()</span>

<span class="s0">}, </span><span class="s4">5000</span><span class="s0">)</span></pre>
</body>
</html>